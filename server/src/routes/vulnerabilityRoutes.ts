import { Router } from 'express'
import { VulnerabilityController } from '../controllers/vulnerabilityController'
import { auth } from '../middleware/auth'
import { body, param, query } from 'express-validator'
import { inputValidation } from '../middleware/inputValidation'

const router = Router()

// Apply authentication middleware to all routes
router.use(auth)

/**
 * @route   POST /api/vulnerability/scan/dependencies
 * @desc    Scan dependencies for vulnerabilities
 * @access  Private (Admin/Security roles)
 */
router.post(
  '/scan/dependencies',
  [
    body('projectPath')
      .optional()
      .isString()
      .trim()
      .isLength({ min: 1, max: 500 })
      .withMessage('Project path must be a valid string')
  ],
  inputValidation,
  VulnerabilityController.scanDependencies
)

/**
 * @route   GET /api/vulnerability/:vulnerabilityId
 * @desc    Get vulnerability details by ID
 * @access  Private
 */
router.get(
  '/:vulnerabilityId',
  [
    param('vulnerabilityId')
      .isString()
      .trim()
      .isLength({ min: 1, max: 100 })
      .withMessage('Vulnerability ID must be a valid string')
  ],
  inputValidation,
  VulnerabilityController.getVulnerability
)

/**
 * @route   PUT /api/vulnerability/:vulnerabilityId/status
 * @desc    Update vulnerability status
 * @access  Private (Admin/Security roles)
 */
router.put(
  '/:vulnerabilityId/status',
  [
    param('vulnerabilityId')
      .isString()
      .trim()
      .isLength({ min: 1, max: 100 })
      .withMessage('Vulnerability ID must be a valid string'),
    body('status')
      .isIn(['OPEN', 'IN_PROGRESS', 'FIXED', 'ACCEPTED_RISK', 'FALSE_POSITIVE', 'WONT_FIX'])
      .withMessage('Status must be a valid vulnerability status'),
    body('notes')
      .optional()
      .isString()
      .trim()
      .isLength({ max: 1000 })
      .withMessage('Notes must be a string with maximum 1000 characters')
  ],
  inputValidation,
  VulnerabilityController.updateVulnerabilityStatus
)

/**
 * @route   GET /api/vulnerability/:vulnerabilityId/remediation
 * @desc    Track remediation progress for a vulnerability
 * @access  Private
 */
router.get(
  '/:vulnerabilityId/remediation',
  [
    param('vulnerabilityId')
      .isString()
      .trim()
      .isLength({ min: 1, max: 100 })
      .withMessage('Vulnerability ID must be a valid string')
  ],
  inputValidation,
  VulnerabilityController.trackRemediation
)

/**
 * @route   GET /api/vulnerability/stats
 * @desc    Get vulnerability statistics
 * @access  Private
 */
router.get(
  '/stats',
  [
    query('days')
      .optional()
      .isInt({ min: 1, max: 365 })
      .withMessage('Days must be an integer between 1 and 365')
  ],
  inputValidation,
  VulnerabilityController.getVulnerabilityStats
)

/**
 * @route   POST /api/vulnerability/cicd/validate-gates
 * @desc    Validate CI/CD security gates
 * @access  Private (Admin/DevOps roles)
 */
router.post(
  '/cicd/validate-gates',
  [
    body('id')
      .isString()
      .trim()
      .isLength({ min: 1, max: 100 })
      .withMessage('Pipeline ID is required'),
    body('name')
      .isString()
      .trim()
      .isLength({ min: 1, max: 200 })
      .withMessage('Pipeline name is required'),
    body('branch')
      .isString()
      .trim()
      .isLength({ min: 1, max: 100 })
      .withMessage('Branch name is required'),
    body('commit')
      .isString()
      .trim()
      .isLength({ min: 1, max: 100 })
      .withMessage('Commit hash is required'),
    body('securityGates')
      .isArray()
      .withMessage('Security gates must be an array')
  ],
  inputValidation,
  VulnerabilityController.validateSecurityGates
)

/**
 * @route   POST /api/vulnerability/cicd/check-deployment
 * @desc    Check if deployment should be blocked due to vulnerabilities
 * @access  Private (Admin/DevOps roles)
 */
router.post(
  '/cicd/check-deployment',
  [
    body('vulnerabilities')
      .isArray()
      .withMessage('Vulnerabilities must be an array')
  ],
  inputValidation,
  VulnerabilityController.checkDeploymentBlocking
)

/**
 * @route   POST /api/vulnerability/cicd/generate-artifacts
 * @desc    Generate security artifacts for build
 * @access  Private (Admin/DevOps roles)
 */
router.post(
  '/cicd/generate-artifacts',
  [
    body('buildId')
      .isString()
      .trim()
      .isLength({ min: 1, max: 100 })
      .withMessage('Build ID is required')
  ],
  inputValidation,
  VulnerabilityController.generateSecurityArtifacts
)

/**
 * @route   POST /api/vulnerability/container/scan
 * @desc    Scan container image for vulnerabilities
 * @access  Private (Admin/DevOps roles)
 */
router.post(
  '/container/scan',
  [
    body('imageId')
      .isString()
      .trim()
      .isLength({ min: 1, max: 200 })
      .withMessage('Image ID is required')
  ],
  inputValidation,
  VulnerabilityController.scanContainerImage
)

/**
 * @route   POST /api/vulnerability/infrastructure/validate
 * @desc    Validate infrastructure configuration security
 * @access  Private (Admin/DevOps roles)
 */
router.post(
  '/infrastructure/validate',
  [
    body('configPath')
      .isString()
      .trim()
      .isLength({ min: 1, max: 500 })
      .withMessage('Configuration path is required')
  ],
  inputValidation,
  VulnerabilityController.validateInfrastructure
)

/**
 * @route   POST /api/vulnerability/kubernetes/enforce-policies
 * @desc    Enforce Kubernetes security policies
 * @access  Private (Admin/DevOps roles)
 */
router.post(
  '/kubernetes/enforce-policies',
  [
    body('policies')
      .isArray()
      .withMessage('Policies must be an array')
  ],
  inputValidation,
  VulnerabilityController.enforceKubernetesPolicies
)

/**
 * @route   POST /api/vulnerability/cloud/assess
 * @desc    Assess cloud resource security
 * @access  Private (Admin/DevOps roles)
 */
router.post(
  '/cloud/assess',
  [
    body('resourceId')
      .isString()
      .trim()
      .isLength({ min: 1, max: 200 })
      .withMessage('Resource ID is required'),
    body('resourceType')
      .isString()
      .trim()
      .isLength({ min: 1, max: 100 })
      .withMessage('Resource type is required')
  ],
  inputValidation,
  VulnerabilityController.assessCloudResource
)

/**
 * @route   GET /api/vulnerability/cicd/security-gates/default
 * @desc    Get default security gates configuration
 * @access  Private
 */
router.get(
  '/cicd/security-gates/default',
  VulnerabilityController.getDefaultSecurityGates
)

/**
 * @route   PUT /api/vulnerability/cicd/security-gates/:gateId
 * @desc    Update security gate configuration
 * @access  Private (Admin/DevOps roles)
 */
router.put(
  '/cicd/security-gates/:gateId',
  [
    param('gateId')
      .isString()
      .trim()
      .isLength({ min: 1, max: 100 })
      .withMessage('Gate ID must be a valid string'),
    body('name')
      .optional()
      .isString()
      .trim()
      .isLength({ min: 1, max: 200 })
      .withMessage('Gate name must be a valid string'),
    body('enabled')
      .optional()
      .isBoolean()
      .withMessage('Enabled must be a boolean'),
    body('blockOnFailure')
      .optional()
      .isBoolean()
      .withMessage('Block on failure must be a boolean')
  ],
  inputValidation,
  VulnerabilityController.updateSecurityGate
)

/**
 * @route   POST /api/vulnerability/schedule-scan
 * @desc    Schedule automated vulnerability scanning
 * @access  Private (Admin roles)
 */
router.post(
  '/schedule-scan',
  [
    body('cronExpression')
      .optional()
      .isString()
      .trim()
      .matches(/^(\*|([0-9]|1[0-9]|2[0-9]|3[0-9]|4[0-9]|5[0-9])|\*\/([0-9]|1[0-9]|2[0-9]|3[0-9]|4[0-9]|5[0-9])) (\*|([0-9]|1[0-9]|2[0-3])|\*\/([0-9]|1[0-9]|2[0-3])) (\*|([1-9]|1[0-9]|2[0-9]|3[0-1])|\*\/([1-9]|1[0-9]|2[0-9]|3[0-1])) (\*|([1-9]|1[0-2])|\*\/([1-9]|1[0-2])) (\*|([0-6])|\*\/([0-6]))$/)
      .withMessage('Cron expression must be valid')
  ],
  inputValidation,
  VulnerabilityController.scheduleAutomatedScan
)

export default router