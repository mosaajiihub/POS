import { describe, it, expect, beforeAll, afterAll } from 'vitest'
import request from 'supertest'
import express from 'express'
import vulnerabilityRoutes from '../routes/vulnerabilityRoutes'

const app = express()
app.use(express.json())

// Mock auth middleware for testing
app.use((req, res, next) => {
  req.user = { id: 'test-user', role: 'admin' }
  next()
})

app.use('/api/vulnerability', vulnerabilityRoutes)

describe('Vulnerability Controller Integration Tests', () => {
  describe('GET /api/vulnerability/stats', () => {
    it('should return vulnerability statistics', async () => {
      const response = await request(app)
        .get('/api/vulnerability/stats')
        .expect(200)

      expect(response.body.success).toBe(true)
      expect(response.body.data).toBeDefined()
      expect(response.body.data).toHaveProperty('totalScans')
      expect(response.body.data).toHaveProperty('totalVulnerabilities')
      expect(response.body.data).toHaveProperty('criticalCount')
    })

    it('should accept days parameter', async () => {
      const response = await request(app)
        .get('/api/vulnerability/stats?days=7')
        .expect(200)

      expect(response.body.success).toBe(true)
      expect(response.body.data).toBeDefined()
    })

    it('should reject invalid days parameter', async () => {
      const response = await request(app)
        .get('/api/vulnerability/stats?days=invalid')
        .expect(400)

      expect(response.body.success).toBe(false)
    })
  })

  describe('GET /api/vulnerability/cicd/security-gates/default', () => {
    it('should return default security gates configuration', async () => {
      const response = await request(app)
        .get('/api/vulnerability/cicd/security-gates/default')
        .expect(200)

      expect(response.body.success).toBe(true)
      expect(response.body.data).toBeDefined()
      expect(Array.isArray(response.body.data)).toBe(true)
    })
  })

  describe('POST /api/vulnerability/scan/dependencies', () => {
    it('should accept dependency scan request', async () => {
      const response = await request(app)
        .post('/api/vulnerability/scan/dependencies')
        .send({ projectPath: '/test/path' })

      // Should not fail due to validation errors
      expect(response.status).not.toBe(400)
    })

    it('should reject invalid project path', async () => {
      const response = await request(app)
        .post('/api/vulnerability/scan/dependencies')
        .send({ projectPath: '' })
        .expect(400)

      expect(response.body.success).toBe(false)
    })
  })

  describe('POST /api/vulnerability/container/scan', () => {
    it('should require imageId parameter', async () => {
      const response = await request(app)
        .post('/api/vulnerability/container/scan')
        .send({})
        .expect(400)

      expect(response.body.success).toBe(false)
      expect(response.body.message).toBe('Image ID is required')
    })

    it('should accept valid imageId', async () => {
      const response = await request(app)
        .post('/api/vulnerability/container/scan')
        .send({ imageId: 'nginx:latest' })

      // Should not fail due to validation errors
      expect(response.status).not.toBe(400)
    })
  })

  describe('POST /api/vulnerability/infrastructure/validate', () => {
    it('should require configPath parameter', async () => {
      const response = await request(app)
        .post('/api/vulnerability/infrastructure/validate')
        .send({})
        .expect(400)

      expect(response.body.success).toBe(false)
      expect(response.body.message).toBe('Configuration path is required')
    })

    it('should accept valid configPath', async () => {
      const response = await request(app)
        .post('/api/vulnerability/infrastructure/validate')
        .send({ configPath: '/path/to/terraform' })

      // Should not fail due to validation errors
      expect(response.status).not.toBe(400)
    })
  })

  describe('PUT /api/vulnerability/:vulnerabilityId/status', () => {
    it('should require valid status', async () => {
      const response = await request(app)
        .put('/api/vulnerability/test-id/status')
        .send({ status: 'INVALID_STATUS' })
        .expect(400)

      expect(response.body.success).toBe(false)
    })

    it('should accept valid status', async () => {
      const response = await request(app)
        .put('/api/vulnerability/test-id/status')
        .send({ 
          status: 'FIXED',
          notes: 'Fixed by updating dependency'
        })

      // Should not fail due to validation errors
      expect(response.status).not.toBe(400)
    })
  })

  describe('POST /api/vulnerability/schedule-scan', () => {
    it('should accept valid cron expression', async () => {
      const response = await request(app)
        .post('/api/vulnerability/schedule-scan')
        .send({ cronExpression: '0 2 * * *' })

      // Should not fail due to validation errors
      expect(response.status).not.toBe(400)
    })

    it('should reject invalid cron expression', async () => {
      const response = await request(app)
        .post('/api/vulnerability/schedule-scan')
        .send({ cronExpression: 'invalid-cron' })
        .expect(400)

      expect(response.body.success).toBe(false)
    })
  })
})